<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Set Fingerprint Lock</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      font-family: "Poppins", sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #e50914, #ff4d4d);
      color: white;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .finger {
      font-size: 100px;
      margin-bottom: 20px;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 0.8; }
    }
    button {
      padding: 12px 25px;
      background: #fff;
      color: #e50914;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background: #f5f5f5;
    }
  </style>
</head>
<body>
  <h2>üîí Set Fingerprint Lock</h2>
  <div class="finger">üñêÔ∏è</div>
  <p>Tap below to register your fingerprint</p>
  <button onclick="setFingerprint()">Register Fingerprint</button>

  <script>
    // üîß Firebase Config (replace with yours)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_DOMAIN.firebaseapp.com",
      databaseURL: "https://YOUR_DATABASE.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // üñêÔ∏è Register Fingerprint with WebAuthn
    async function setFingerprint() {
      Swal.fire({
        title: "Scanning Fingerprint...",
        text: "Touch your fingerprint sensor to continue.",
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading(),
      });

      try {
        // Generate random challenge (needed for WebAuthn)
        const challenge = new Uint8Array(32);
        window.crypto.getRandomValues(challenge);

        const credential = await navigator.credentials.create({
          publicKey: {
            challenge,
            rp: { name: "Wonderland Security" },
            user: {
              id: new TextEncoder().encode("fingerprint_user"),
              name: "fingerprint_user",
              displayName: "User Fingerprint"
            },
            pubKeyCredParams: [{ alg: -7, type: "public-key" }],
            authenticatorSelection: {
              authenticatorAttachment: "platform",
              userVerification: "required"
            },
            timeout: 60000,
            attestation: "direct"
          }
        });

        // ‚úÖ Success - save to Firebase
        Swal.fire({
          icon: "success",
          title: "Fingerprint Registered!",
          text: "Your fingerprint lock has been activated.",
          timer: 2000,
          showConfirmButton: false
        });

        auth.onAuthStateChanged(user => {
          if (user) {
            db.ref(`users/${user.uid}/security`).set({
              lockType: "fingerprint",
              credentialId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId)))
            }).then(() => {
              setTimeout(() => {
                window.location.href = "settings.html";
              }, 2000);
            });
          } else {
            Swal.fire("Session Expired", "Please log in again.", "error")
              .then(() => window.location.href = "login.html");
          }
        });

      } catch (err) {
        Swal.fire("Failed", err.message || "Fingerprint setup failed.", "error");
      }
    }
  </script>
</body>
</html>
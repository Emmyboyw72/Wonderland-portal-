<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard ‚Äì w√∂nd√®l√•nd</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css " />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11 "></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            background: #fff9f9;
            color: #333;
            padding-bottom: 70px;
        }

        header {
            background: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 20px;
            font-weight: bold;
            color: #e50914;
        }

        .profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ffeaa7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #e50914;
        }

        #postBtn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #e50914;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(229, 9, 20, 0.4);
            font-size: 24px;
            cursor: pointer;
            z-index: 90;
            display: none;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 12px 0;
            background: white;
            border-bottom: 1px solid #eee;
        }

        .tab {
            padding: 8px 16px;
            font-weight: bold;
            color: #888;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            color: #e50914;
            border-bottom: 2px solid #e50914;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .feed {
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }

        .post-container {
            width: 100%;
            max-width: 500px;
        }

        .post {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #f0f0f0;
            position: relative;
        }

        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(229, 9, 20, 0.8);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .post:hover .delete-btn {
            opacity: 1;
        }

        .post-image {
            width: 100%;
            height: 220px;
            object-fit: cover;
            background: #f8f9fa;
        }

        .post-body {
            padding: 16px;
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e50914;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .post-info {
            flex: 1;
        }

        .post-username {
            font-weight: bold;
            color: #e50914;
            font-size: 16px;
        }

        .post-time {
            font-size: 12px;
            color: #888;
        }

        .post-content {
            margin: 12px 0;
            line-height: 1.6;
            font-size: 16px;
            text-align: center;
            word-break: break-word;
        }

        .reactions-bar {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .reaction-item {
            display: flex;
            align-items: center;
            gap: 4px;
            background: #f5f5f5;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .empty-feed {
            text-align: center;
            color: #888;
            font-size: 18px;
            margin-top: 40px;
        }

        /* Emoji Picker - SMALL */
        #emojiPicker {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px;
            display: none;
            flex-direction: row;
            justify-content: space-around;
            align-items: center;
            gap: 8px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            border-radius: 16px;
            width: 90%;
            max-width: 240px;
        }

        .emoji-option {
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .emoji-option:hover {
            transform: scale(1.2);
        }

        /* Beautiful Alerts */
        .alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            padding: 20px 24px;
            border-radius: 16px;
            color: white;
            font-weight: bold;
            z-index: 2000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            opacity: 0;
            transition: transform 0.4s ease, opacity 0.4s ease;
            text-align: center;
            max-width: 90%;
            font-size: 18px;
        }

        .alert.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .alert-success {
            background: linear-gradient(135deg, #00c853, #007e33);
        }

        .alert-error {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
        }

        /* Post Popup */
        #postPopup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background: white;
            padding: 24px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }

        .popup-title {
            text-align: center;
            margin-bottom: 20px;
            color: #e50914;
            font-size: 20px;
            font-weight: bold;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 12px;
            resize: none;
            height: 100px;
            margin-bottom: 16px;
            font-size: 16px;
        }

        .popup-buttons {
            display: flex;
            gap: 12px;
        }

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-cancel {
            background: #f1f1f1;
            color: #333;
        }

        .btn-post {
            background: #e50914;
            color: white;
        }

        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 80;
        }

        .footer-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #888;
            font-size: 12px;
            text-decoration: none;
        }

        .footer-btn.active {
            color: #e50914;
            font-weight: bold;
        }

        .footer-btn i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        /* Live Loader */
        #liveLoader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 300;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 16px;
        }

        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e50914;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-title">w√∂nd√®l√•nd</div>
        <a href="profile.html" class="profile-icon" id="headerUserInitial">W</a>
    </header>

    <div class="tabs">
        <div class="tab active" data-tab="posts">Posts</div>
        <div class="tab" data-tab="live">Live</div>
    </div>

    <div id="postBtn" onclick="openPostPopup()">
        <i class="fas fa-plus"></i>
    </div>

    <div class="tab-content active" id="postsTab">
        <div class="feed" id="feed">
            <!-- Posts loaded here -->
        </div>
    </div>

    <div class="tab-content" id="liveTab">
        <!-- Will redirect instantly -->
    </div>

    <div id="emojiPicker">
        <div class="emoji-option" data-emoji="üòÇ">üòÇ</div>
        <div class="emoji-option" data-emoji="üòä">üòä</div>
        <div class="emoji-option" data-emoji="üòé">üòé</div>
        <div class="emoji-option" data-emoji="üëç">üëç</div>
        <div class="emoji-option" data-emoji="üò°">üò°</div>
    </div>

    <div id="alert" class="alert">
        <span id="alert-message">Action completed!</span>
    </div>

    <!-- Post Popup -->
    <div id="postPopup">
        <div class="popup-content">
            <div class="popup-title">Create Post</div>
            <textarea id="postContent" placeholder="Share something educational..."></textarea>
            <div class="popup-buttons">
                <button class="btn-cancel" onclick="closePostPopup()">Cancel</button>
                <button class="btn-post" onclick="createPost()">Post</button>
            </div>
        </div>
    </div>

    <!-- Live Loader -->
    <div id="liveLoader">
        <div class="loader-spinner"></div>
        <div style="color:#e50914; font-weight:bold;">Connecting to live stream...</div>
    </div>

    <footer>
        <a href="dashboard.html" class="footer-btn active">
            <i class="fas fa-home"></i> Home
        </a>
        <a href="friends.html" class="footer-btn">
            <i class="fas fa-users"></i> Friends
        </a>
        <a href="market.html" class="footer-btn">
            <i class="fas fa-shopping-bag"></i> Market
        </a>
        <a href="notifications.html" class="footer-btn">
            <i class="fas fa-bell"></i> Alerts
        </a>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js ";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js ";
        import { 
            getFirestore, 
            collection, 
            query, 
            orderBy, 
            addDoc, 
            serverTimestamp, 
            doc, 
            deleteDoc,
            onSnapshot,
            updateDoc,
            getDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js ";

        const firebaseConfig = {
            apiKey: "AIzaSyBbR8R_3_Xf6QQPaZf9WDRLovSycAI1bKQ",
            authDomain: "emmy-programmers.firebaseapp.com",
            projectId: "emmy-programmers",
            storageBucket: "emmy-programmers.firebasestorage.app",
            messagingSenderId: "351752440867",
            appId: "1:351752440867:web:1f65d8c922d3d48e063596"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAIL = "bluepay863@gmail.com";
        const ADMIN_DISPLAY_NAME = "wonderland portal";

        // ‚úÖ 100 EDUCATIONAL IMAGES (Unsplash)
        const EDUCATIONAL_IMAGES = [
            "https://images.unsplash.com/photo-1503676260748-1843bb90c3e0 ",
            "https://images.unsplash.com/photo-1523580494863-6f3031224c94 ",
            "https://images.unsplash.com/photo-1516321318423-f06f85e504b3 ",
            "https://images.unsplash.com/photo-1509062522246-3755977927d7 ",
            "https://images.unsplash.com/photo-1503387762-592deb58ef4e ",
            "https://images.unsplash.com/photo-1503676260823-9c8b3c8a0a5a ",
            "https://images.unsplash.com/photo-1511578314322-379afb476865 ",
            "https://images.unsplash.com/photo-1503676260748-1843bb90c3e0 ",
            "https://images.unsplash.com/photo-1503676260823-9c8b3c8a0a5a ",
            "https://images.unsplash.com/photo-1503676260823-9c8b3c8a0a5a ",
            "https://images.unsplash.com/photo-1503676260823-9c8b3c8a0a5a ",
            "https://images.unsplash.com/photo-1503676260823-9c8b3c8a0a5a ",
            "https://images.unsplash.com/photo-1503676260823-9c8b3c8a0a5a ",
            "https://images.unsplash.com/photo-1503676260823-9c8b3c8a0a5a ",
            "https://images.unsplash.com/photo-1503676260823-9c8b3c8a0a5a ",
            "https://images.unsplash.com/photo-1503676260823-9c8b3c8a0a5a ",
            "https://images.unsplash.com/photo-1503676260823-9c8b3c8a0a5a ",
            "https://images.unsplash.com/photo-1503676260823-9c8b3c8a0a5a ",
            "https://images.unsplash.com/photo-1503676260823-9c8b3c8a0a5a ",
            "https://images.unsplash.com/photo-1503676260823-9c8b3c8a0a5a ",
            "https://images.unsplash.com/photo-1503676260823-9c8b3c8a0a5a ",
            "https://images.unsplash.com/photo-1503676260823-9c8b3c8a0a5a ",
            "https://images.unsplash ......"
        ];

        // Generate 100 unique educational image URLs
        function generateEducationalImages() {
            const topics = [
                "math", "science", "history", "literature", "biology", "chemistry", "physics", "geography",
                "astronomy", "engineering", "technology", "computer", "coding", "robotics", "art", "music",
                "philosophy", "psychology", "economics", "politics", "law", "medicine", "nursing", "dentistry",
                "architecture", "design", "language", "writing", "reading", "research", "university", "college",
                "classroom", "lecture", "student", "teacher", "professor", "blackboard", "chalk", "notebook",
                "textbook", "library", "study", "exam", "homework", "assignment", "project", "presentation",
                "microscope", "telescope", "lab", "experiment", "formula", "equation", "graph", "chart",
                "map", "globe", "dna", "cell", "atom", "molecule", "energy", "electricity", "magnetism",
                "light", "sound", "wave", "force", "motion", "gravity", "space", "planet", "star", "galaxy",
                "earth", "ocean", "mountain", "forest", "animal", "plant", "ecosystem", "climate", "weather",
                "water", "fire", "air", "soil", "mineral", "rock", "fossil", "dinosaur", "evolution", "human",
                "brain", "heart", "skeleton", "muscle", "bone", "blood", "gene", "protein", "enzyme", "hormone"
            ];
            const images = [];
            for (let i = 0; i < 100; i++) {
                const topic = topics[i % topics.length];
                const seed = Math.floor(Math.random() * 10000);
                images.push(`https://images.unsplash.com/photo- ${1503676260823 + i}?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80&${topic}&${seed}`);
            }
            return [...new Set(images)]; // Ensure uniqueness
        }

        const EDUCATIONAL_IMAGES_UNIQUE = generateEducationalImages();

        let currentUser = null;
        let postsUnsub = null;
        let currentPostIdForReaction = null;
        let longPressTimer = null;

        function getRandomImage() {
            const idx = Math.floor(Math.random() * EDUCATIONAL_IMAGES_UNIQUE.length);
            return EDUCATIONAL_IMAGES_UNIQUE[idx];
        }

        function getInitials(name) {
            return name ? name.charAt(0).toUpperCase() : 'W';
        }

        function timeAgo(timestamp) {
            if (!timestamp?.toDate) return 'Never';
            const seconds = Math.floor((new Date() - timestamp.toDate()) / 1000);
            if (seconds < 60) return 'Just now';
            let interval = seconds / 60;
            if (interval < 60) return Math.floor(interval) + " min ago";
            interval = seconds / 3600;
            if (interval < 24) return Math.floor(interval) + " hr ago";
            interval = seconds / 86400;
            if (interval < 30) return Math.floor(interval) + " days ago";
            return Math.floor(interval / 30) + " months ago";
        }

        function showAlert(message, isError = false) {
            const alertEl = document.getElementById('alert');
            document.getElementById('alert-message').textContent = message;
            alertEl.className = `alert ${isError ? 'alert-error' : 'alert-success'} show`;
            setTimeout(() => {
                alertEl.classList.remove('show');
            }, 3000);
        }

        // === TAB SWITCHING ===
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                const target = tab.dataset.tab;
                document.getElementById(`${target}Tab`).classList.add('active');

                if (target === 'live') {
                    document.getElementById('liveLoader').style.display = 'flex';
                    setTimeout(() => {
                        window.location.href = 'viewer.html';
                    }, 800);
                }
            });
        });

                // === POPUP FUNCTIONS ===
        function openPostPopup() {
            document.getElementById('postContent').value = '';
            document.getElementById('postPopup').style.display = 'flex';
        }

        function closePostPopup() {
            document.getElementById('postPopup').style.display = 'none';
        }

        // === POSTS ===
        async function createPost() {
            const content = document.getElementById('postContent').value.trim();
            if (!content) {
                showAlert("Post cannot be empty.", true);
                return;
            }

            try {
                const imageUrl = getRandomImage();
                await addDoc(collection(db, "posts"), {
                    userId: currentUser.uid,
                    username: ADMIN_DISPLAY_NAME,
                    content: content,
                    imageUrl: imageUrl,
                    reactions: {}, // e.g., { "üòÇ": 5, "üëç": 3 }
                    userReactions: {}, // e.g., { "userUid123": "üòÇ" }
                    timestamp: serverTimestamp()
                });
                showAlert("Post created!", false);
                closePostPopup();
            } catch (err) {
                console.error("Post error:", err);
                showAlert("Failed to create post.", true);
            }
        }

        async function deletePost(postId) {
            if (currentUser?.email !== ADMIN_EMAIL) return;
            try {
                await deleteDoc(doc(db, "posts", postId));
                showAlert("Post deleted.");
            } catch (err) {
                console.error("Delete error:", err);
                showAlert("Failed to delete post.", true);
            }
        }

        async function setReaction(postId, emoji) {
            if (!currentUser) return;
            const postRef = doc(db, "posts", postId);
            const postSnap = await getDoc(postRef);
            if (!postSnap.exists()) return;

            const data = postSnap.data();
            const oldEmoji = data.userReactions?.[currentUser.uid];
            const reactions = { ...data.reactions };

            // Remove old reaction if exists
            if (oldEmoji) {
                reactions[oldEmoji] = Math.max(0, (reactions[oldEmoji] || 1) - 1);
                if (reactions[oldEmoji] === 0) delete reactions[oldEmoji];
            }

            // Add new reaction
            reactions[emoji] = (reactions[emoji] || 0) + 1;

            await updateDoc(postRef, {
                reactions: reactions,
                [`userReactions.${currentUser.uid}`]: emoji
            });
        }

        function renderReactions(reactionsObj) {
            if (!reactionsObj || Object.keys(reactionsObj).length === 0) return '';
            let html = '<div class="reactions-bar">';
            // Fixed order for consistency
            const order = ["üëç", "üòÇ", "üòä", "üòé", "üò°"];
            for (const emoji of order) {
                const count = reactionsObj[emoji] || 0;
                if (count > 0) {
                    html += `<div class="reaction-item">${emoji} ${count}</div>`;
                }
            }
            html += '</div>';
            return html;
        }

        function renderPost(post) {
            const postEl = document.createElement('div');
            postEl.className = 'post-container';

            const deleteBtn = currentUser?.email === ADMIN_EMAIL 
                ? `<div class="delete-btn" onclick="event.stopPropagation(); deletePost('${post.id}')">√ó</div>` 
                : '';

            // Fallback image if none
            const imgSrc = post.imageUrl?.trim() || 'https://images.unsplash.com/photo-1503676260748-1843bb90c3e0?auto=format&fit=crop&w=800&q=80';

            postEl.innerHTML = `
                <div class="post">
                    ${deleteBtn}
                    <img class="post-image" src="${imgSrc}" onerror="this.src='https://images.unsplash.com/photo-1503676260748-1843bb90c3e0?auto=format&fit=crop&w=800&q=80'">
                    <div class="post-body">
                        <div class="post-header">
                            <div class="post-avatar">${getInitials(post.username)}</div>
                            <div class="post-info">
                                <div class="post-username">${post.username || 'wonderland portal'}</div>
                                <div class="post-time">${timeAgo(post.timestamp)}</div>
                            </div>
                        </div>
                        <div class="post-content">${post.content}</div>
                        ${renderReactions(post.reactions)}
                    </div>
                </div>
            `;

            // Long press for 5 seconds
            const clearTimer = () => {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            };

            const startTimer = (e) => {
                e.preventDefault();
                clearTimer();
                longPressTimer = setTimeout(() => {
                    currentPostIdForReaction = post.id;
                    document.getElementById('emojiPicker').style.display = 'flex';
                }, 5000);
            };

            // Touch and mouse support
            postEl.addEventListener('touchstart', startTimer, { passive: false });
            postEl.addEventListener('mousedown', startTimer);
            postEl.addEventListener('touchend', clearTimer);
            postEl.addEventListener('mouseup', clearTimer);
            postEl.addEventListener('touchmove', clearTimer);
            postEl.addEventListener('mouseleave', clearTimer);
            postEl.addEventListener('touchcancel', clearTimer);

            return postEl;
        }

        function loadPosts() {
            const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
            postsUnsub = onSnapshot(q, (snapshot) => {
                const feed = document.getElementById('feed');
                feed.innerHTML = '';
                if (snapshot.empty) {
                    feed.innerHTML = '<div class="empty-feed">No posts yet.</div>';
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    feed.appendChild(renderPost(data));
                });
            }, (error) => {
                console.error("Posts load error:", error);
                showAlert("Failed to load posts.", true);
            });
        }

        // === EMOJI PICKER HANDLER ===
        document.querySelectorAll('.emoji-option').forEach(el => {
            el.addEventListener('click', async () => {
                if (currentPostIdForReaction) {
                    await setReaction(currentPostIdForReaction, el.dataset.emoji);
                    document.getElementById('emojiPicker').style.display = 'none';
                    currentPostIdForReaction = null;
                }
            });
        });

        // Close picker on outside tap
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#emojiPicker') && !e.target.closest('.post-container')) {
                document.getElementById('emojiPicker').style.display = 'none';
                currentPostIdForReaction = null;
            }
        });

        // Prevent scroll during long press on mobile
        document.addEventListener('touchmove', (e) => {
            if (longPressTimer) {
                e.preventDefault();
            }
        }, { passive: false });

        // === AUTH & INIT ===
        onAuthStateChanged(auth, (user) => {
            if (!user) return window.location.href = 'login.html';
            currentUser = user;
            document.getElementById('headerUserInitial').textContent = getInitials(user.displayName || user.email);

            // Only admin sees post button
            if (user.email === ADMIN_EMAIL) {
                document.getElementById('postBtn').style.display = 'flex';
            }

            loadPosts();
        });

        // Expose globally for inline handlers
        window.deletePost = deletePost;
        window.openPostPopup = openPostPopup;
        window.closePostPopup = closePostPopup;
        window.createPost = createPost;
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard – Wonderland</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: #fff9f9;
      color: #333;
      padding-bottom: 70px;
    }

    header {
      background: white;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-title {
      font-size: 20px;
      font-weight: bold;
      color: #e50914;
    }

    .profile-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ffeaa7;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #e50914;
    }

    #postBtn {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #e50914;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(229, 9, 20, 0.4);
      font-size: 24px;
      cursor: pointer;
      z-index: 90;
      display: none; /* Hidden by default */
    }

    .feed {
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
    }

    .post-container {
      width: 100%;
      max-width: 500px;
    }

    .post {
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 1px solid #f0f0f0;
      position: relative;
    }

    .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(229, 9, 20, 0.8);
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .post:hover .delete-btn {
      opacity: 1;
    }

    .post-image {
      width: 100%;
      height: 220px;
      object-fit: cover;
    }

    .post-body {
      padding: 16px;
    }

    .post-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .post-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #fab1a0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .post-info {
      flex: 1;
    }

    .post-username {
      font-weight: bold;
      color: #e50914;
      font-size: 16px;
    }

    .post-time {
      font-size: 12px;
      color: #888;
    }

    .post-content {
      margin: 12px 0;
      line-height: 1.6;
      font-size: 16px;
      text-align: center;
      word-break: break-word;
    }

    .stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 12px 0;
    }

    .stat-badge {
      background: #ffebee;
      color: #c62828;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .post-actions {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 12px;
    }

    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #555;
      cursor: pointer;
      font-size: 14px;
    }

    .action-btn.liked i {
      color: #e50914 !important;
    }

    .empty-feed {
      text-align: center;
      color: #888;
      font-size: 18px;
      margin-top: 40px;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    .footer-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #888;
      font-size: 12px;
      text-decoration: none;
    }

    .footer-btn.active {
      color: #e50914;
      font-weight: bold;
    }

    .footer-btn i {
      font-size: 20px;
      margin-bottom: 4px;
    }

    #postPopup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 200;
      justify-content: center;
      align-items: center;
    }

    .popup-content {
      background: white;
      padding: 24px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }

    .popup-title {
      text-align: center;
      margin-bottom: 20px;
      color: #e50914;
      font-size: 20px;
      font-weight: bold;
    }

    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 12px;
      resize: none;
      height: 100px;
      margin-bottom: 16px;
      font-size: 16px;
    }

    .popup-buttons {
      display: flex;
      gap: 12px;
    }

    button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
    }

    .btn-cancel {
      background: #f1f1f1;
      color: #333;
    }

    .btn-post {
      background: #e50914;
      color: white;
    }
  </style>
</head>
<body>

  <header>
    <div class="header-title">Wonderland</div>
    <a href="profile.html" class="profile-icon" id="headerUserInitial">U</a>
  </header>

  <div id="postBtn">
    <i class="fas fa-plus"></i>
  </div>

  <div class="feed" id="feed">
    <!-- Posts will appear here -->
  </div>

  <!-- Post Popup -->
  <div id="postPopup">
    <div class="popup-content">
      <div class="popup-title">Create Post</div>
      <textarea id="postContent" placeholder="What's on your mind?"></textarea>
      <div class="popup-buttons">
        <button class="btn-cancel" onclick="closePopup()">Cancel</button>
        <button class="btn-post" onclick="createPost()">Post</button>
      </div>
    </div>
  </div>

  <footer>
    <a href="dashboard.html" class="footer-btn active">
      <i class="fas fa-home"></i> Home
    </a>
    <a href="friends.html" class="footer-btn">
      <i class="fas fa-users"></i> Friends
    </a>
    <a href="market.html" class="footer-btn">
      <i class="fas fa-shopping-bag"></i> Market
    </a>
    <a href="notifications.html" class="footer-btn">
      <i class="fas fa-bell"></i> Alerts
    </a>
  </footer>

  <script type="module">
    // ✅ FIXED: NO TRAILING SPACES IN IMPORTS
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, getDocs, addDoc, serverTimestamp, doc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbR8R_3_Xf6QQPaZf9WDRLovSycAI1bKQ",
      authDomain: "emmy-programmers.firebaseapp.com",
      projectId: "emmy-programmers",
      storageBucket: "emmy-programmers.firebasestorage.app",
      messagingSenderId: "351752440867",
      appId: "1:351752440867:web:1f65d8c922d3d48e063596"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_EMAIL = "bluepay863@gmail.com";
    let currentUser = null;
    const likedPosts = new Set();

    // ✅ 100+ school images — NO TRAILING SPACES
    const schoolImages = [
      "https://images.unsplash.com/photo-1523580494863-6f3031224c94",
      "https://images.unsplash.com/photo-1509062522246-3755977927d7",
      "https://images.unsplash.com/photo-1589998059171-988d887df646",
      "https://images.unsplash.com/photo-1523240795612-9a054b0db644",
      "https://images.unsplash.com/photo-1516802273409-68526ee1bdd6",
      "https://images.unsplash.com/photo-1503676260728-1c00da094a0b",
      "https://images.unsplash.com/photo-1506157786151-b8491531f063",
      "https://images.unsplash.com/photo-1546069901-ba9599a7e63c",
      "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4",
      "https://images.unsplash.com/photo-1565299624946-b2f2b8c5e7a6",
      "https://images.unsplash.com/photo-1555939594-58d7cb561ad1",
      "https://images.unsplash.com/photo-1563245372-f60088942622",
      "https://images.unsplash.com/photo-1547592167-2c8c2a8a8a8a",
      "https://images.unsplash.com/photo-1603133872878-684f20873a82",
      "https://images.unsplash.com/photo-1565958011703-44f9829ba187",
      "https://images.unsplash.com/photo-1519708227418-c8fd9a32b7a2",
      "https://images.unsplash.com/photo-1504674900247-0877df9cc836",
      "https://images.unsplash.com/photo-1528735602780-2552fd46c7af",
      "https://images.unsplash.com/photo-1562967917-995d8c8765b9",
      "https://images.unsplash.com/photo-1563379973274-94c2c6a61a33",
      "https://images.unsplash.com/photo-1556911220-e15b29be8c8f",
      "https://images.unsplash.com/photo-1557804506-669a67965ba0",
      "https://images.unsplash.com/photo-1562967916-9b5d5b8c8b5e",
      "https://images.unsplash.com/photo-1626082927389-6cd3e2e7b7c5",
      "https://images.unsplash.com/photo-1603532648955-a0f9a5e7c7e0",
      "https://images.unsplash.com/photo-1565557623262-b5193d9e68c0",
      "https://images.unsplash.com/photo-1578985545062-69928b1d9587",
      "https://images.unsplash.com/photo-1606312619070-d48b4c652a52",
      "https://images.unsplash.com/photo-1633332758227-9c7e73a2d5f0",
      "https://images.unsplash.com/photo-1603302576718-8e5e9e8e9e8e",
      "https://images.unsplash.com/photo-1584132960527-9a9e5a8c8f0a",
      "https://images.unsplash.com/photo-1605256789628-955f0d5c5a9e",
      "https://images.unsplash.com/photo-1600271886742-f049cd55a5d4",
      "https://images.unsplash.com/photo-1595008937846-8a6e8c8f0a8a",
      "https://images.unsplash.com/photo-1503572378481-2d3c7e4a5d8e",
      "https://images.unsplash.com/photo-1511277425579-2e5d9c3c3a28",
      "https://images.unsplash.com/photo-1529337530680-9e5a6b3a2c4e",
      "https://images.unsplash.com/photo-1543269865-cbf427effbad",
      "https://images.unsplash.com/photo-1531206715517-5c0ba140b2b8",
      "https://images.unsplash.com/photo-1506218583350-91e8e4d6a90d"
      // You can add more if needed — 40 is enough for demo
    ];

    function getInitials(name) {
      return name ? name.charAt(0).toUpperCase() : 'U';
    }

    function timeAgo(timestamp) {
      if (!timestamp?.toDate) return 'Just now';
      const seconds = Math.floor((new Date() - timestamp.toDate()) / 1000);
      if (seconds < 60) return 'Just now';
      let interval = seconds / 60;
      if (interval < 60) return Math.floor(interval) + "min ago";
      interval = seconds / 3600;
      if (interval < 24) return Math.floor(interval) + "hr ago";
      return Math.floor(seconds / 86400) + "d ago";
    }

    function formatLikes(num) {
      if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
      return num.toString();
    }

    function showAlert(message, isError = false) {
      Swal.fire({
        text: message,
        icon: isError ? 'error' : 'success',
        timer: 3000,
        showConfirmButton: false
      });
    }

    function closePopup() {
      document.getElementById('postPopup').style.display = 'none';
    }

    async function createPost() {
      const content = document.getElementById('postContent').value.trim();
      if (!content) return showAlert("Post cannot be empty.", true);

      Swal.fire({
        title: 'Posting...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      try {
        const randomImage = schoolImages[Math.floor(Math.random() * schoolImages.length)];
        await addDoc(collection(db, "posts"), {
          userId: currentUser.uid,
          username: currentUser.displayName || currentUser.email.split('@')[0],
          content: content,
          imageUrl: randomImage,
          baseLikes: Math.floor(Math.random() * 300) + 200, // 200–499
          timestamp: serverTimestamp()
        });
        Swal.close();
        showAlert("Post created!");
        closePopup();
        document.getElementById('postContent').value = '';
        loadPosts();
      } catch (err) {
        Swal.close();
        console.error(err);
        showAlert("Failed to create post.", true);
      }
    }

    function calculateLikes(baseLikes, timestamp) {
      if (!timestamp?.toDate) return baseLikes;
      const ageMs = new Date() - timestamp.toDate();
      const hours = ageMs / (1000 * 60 * 60);
      if (hours >= 72) {
        return baseLikes + 800 + Math.floor(Math.random() * 200); // ~1000–1699
      } else if (hours >= 24) {
        return baseLikes + 300 + Math.floor(Math.random() * 200); // ~500–1199
      }
      return baseLikes; // 200–499
    }

    async function likePost(postId, likeBtn) {
      if (!currentUser) return showAlert("You must be logged in to like.", true);
      if (likedPosts.has(postId)) return;

      try {
        const likeRef = doc(db, "likes", `${currentUser.uid}_${postId}`);
        await setDoc(likeRef, { likedAt: serverTimestamp() });
        likedPosts.add(postId);

        const statBadge = likeBtn.closest('.post').querySelector('.stat-badge');
        let currentLikes = parseInt(statBadge.dataset.likes) || 200;
        currentLikes += 1;
        statBadge.dataset.likes = currentLikes;
        statBadge.textContent = `❤️ ${formatLikes(currentLikes)}`;
        likeBtn.classList.add('liked');
        likeBtn.querySelector('i').className = "fas fa-heart";

        showAlert("Liked!");
      } catch (err) {
        console.error(err);
        showAlert("Failed to like post.", true);
      }
    }

    async function requestDeletePost(postId) {
      const result = await Swal.fire({
        title: 'Delete Post?',
        text: "This action cannot be undone.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel'
      });
      if (result.isConfirmed) {
        try {
          await deleteDoc(doc(db, "posts", postId));
          Swal.fire('Deleted!', 'Your post has been removed.', 'success');
          loadPosts();
        } catch (err) {
          console.error(err);
          showAlert("Failed to delete post.", true);
        }
      }
    }

    async function loadPosts() {
      const feed = document.getElementById('feed');
      feed.innerHTML = '<div class="empty-feed">Loading...</div>';

      try {
        const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          feed.innerHTML = '<div class="empty-feed">No posts yet.</div>';
          return;
        }

        feed.innerHTML = '';
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const postId = doc.id;
          const isOwner = currentUser && data.userId === currentUser.uid;
          const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;

          const postTime = timeAgo(data.timestamp);
          const likes = calculateLikes(data.baseLikes, data.timestamp);
          const canDelete = isAdmin || isOwner;

          const postEl = document.createElement('div');
          postEl.className = 'post-container';
          postEl.innerHTML = `
            <div class="post">
              ${canDelete ? `<div class="delete-btn" onclick="requestDeletePost('${postId}')">×</div>` : ''}
              <img class="post-image" src="${data.imageUrl}" alt="Post image" onerror="this.style.display='none'">
              <div class="post-body">
                <div class="post-header">
                  <div class="post-avatar">${getInitials(data.username)}</div>
                  <div class="post-info">
                    <div class="post-username">${data.username}</div>
                    <div class="post-time">${postTime}</div>
                  </div>
                </div>
                <div class="post-content">${data.content}</div>
                <div class="stats">
                  <div class="stat-badge" data-likes="${likes}">❤️ ${formatLikes(likes)}</div>
                </div>
                <div class="post-actions">
                  <div class="action-btn" onclick="likePost('${postId}', this)">
                    <i class="far fa-heart"></i>
                    <span>Like</span>
                  </div>
                </div>
              </div>
            </div>
          `;
          feed.appendChild(postEl);
        });
      } catch (err) {
        console.error(err);
        feed.innerHTML = '<div class="empty-feed">Failed to load posts.</div>';
      }
    }

    // Auth state listener
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        document.getElementById('headerUserInitial').textContent = getInitials(user.displayName || user.email.split('@')[0]);

        // ✅ Show post button ONLY for admin
        if (user.email === ADMIN_EMAIL) {
          document.getElementById('postBtn').style.display = 'flex';
        }

        loadPosts();
      } else {
        window.location.href = 'login.html';
      }
    });

    // Attach global functions to window for inline onclick
    window.closePopup = closePopup;
    window.createPost = createPost;
    window.likePost = likePost;
    window.requestDeletePost = requestDeletePost;

    // Open post popup
    document.getElementById('postBtn').addEventListener('click', () => {
      document.getElementById('postPopup').style.display = 'flex';
    });
  </script>
</body>
</html>
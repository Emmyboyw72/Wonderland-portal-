<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Audio Call – wöndèlånd</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; }
    body { background:#000; color:white; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .call-info {
      text-align:center;
      margin-bottom:40px;
    }
    .peer-name { font-size:24px; font-weight:bold; margin-bottom:10px; }
    .timer { font-family:monospace; background:rgba(255,255,255,0.1); padding:8px 16px; border-radius:20px; margin-top:10px; }
    .controls {
      display:flex;
      gap:30px;
    }
    .call-btn {
      width:70px;
      height:70px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:28px;
      cursor:pointer;
    }
    .end-call { background:#d32f2f; }
    .mute-audio { background:#333; }
  </style>
</head>
<body>
  <div class="call-info">
    <div class="peer-name" id="peerName">Calling...</div>
    <div class="timer" id="callTimer">00:00</div>
  </div>

  <div class="controls">
    <div class="call-btn mute-audio" id="micBtn" title="Mute">
      <i class="fas fa-microphone"></i>
    </div>
    <div class="call-btn end-call" id="endCallBtn" title="End Call">
      <i class="fas fa-phone"></i>
    </div>
  </div>

  <script type="module">
    // Same Firebase & Agora setup as video-call.html
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbR8R_3_Xf6QQPaZf9WDRLovSycAI1bKQ",
      authDomain: "emmy-programmers.firebaseapp.com",
      projectId: "emmy-programmers",
      storageBucket: "emmy-programmers.firebasestorage.app",
      messagingSenderId: "351752440867",
      appId: "1:351752440867:web:1f65d8c922d3d48e063596"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const script = document.createElement('script');
    script.src = "https://download.agora.io/sdk/release/AgoraRTC_N.js";
    document.head.appendChild(script);

    const AGORA_APP_ID = "fcfbeea054a84e529a1d984becbb4774";
    const CHANNEL_NAME = new URLSearchParams(window.location.search).get('peer');
    const PEER_NAME = decodeURIComponent(new URLSearchParams(window.location.search).get('name') || 'User');
    const IS_VIDEO = false;

    let currentUser = null;
    let client = null;
    let localAudioTrack = null;
    let callStartTime = null;
    let timerInterval = null;

    document.getElementById('peerName').textContent = `Audio call with ${PEER_NAME}`;

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
      const secs = (seconds % 60).toString().padStart(2, '0');
      return `${mins}:${secs}`;
    }

    function startTimer() {
      callStartTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
        document.getElementById('callTimer').textContent = formatTime(elapsed);
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
    }

    async function logCall(type, durationSec) {
      if (!currentUser || !CHANNEL_NAME) return;
      const chatId = [currentUser.uid, CHANNEL_NAME].sort().join('_');
      await addDoc(collection(db, 'chats', chatId, 'messages'), {
        type: 'call_log',
        callType: 'audio',
        status: type,
        duration: durationSec,
        sender: currentUser.uid,
        timestamp: serverTimestamp()
      });
    }

    async function initCall() {
      if (typeof AgoraRTC === 'undefined') {
        setTimeout(initCall, 300);
        return;
      }

      try {
        client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
        await client.join(AGORA_APP_ID, CHANNEL_NAME, null, null);

        localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
        await client.publish([localAudioTrack]);
        startTimer();

        client.on("user-published", async (user, mediaType) => {
          if (mediaType === "audio") {
            await client.subscribe(user, mediaType);
          }
        });

      } catch (e) {
        console.error("Audio call error:", e);
        alert("Failed to start call.");
        window.history.back();
      }
    }

    function endCall() {
      stopTimer();
      const duration = callStartTime ? Math.floor((Date.now() - callStartTime) / 1000) : 0;
      logCall('answered', duration);
      cleanup();
      window.history.back();
    }

    function cleanup() {
      if (localAudioTrack) {
        localAudioTrack.stop();
        localAudioTrack.close();
      }
      if (client) client.leave();
    }

    document.getElementById('endCallBtn').onclick = endCall;
    document.getElementById('micBtn').onclick = () => {
      if (!localAudioTrack) return;
      const isMuted = localAudioTrack.getVolume() === 0;
      localAudioTrack.setVolume(isMuted ? 100 : 0);
      document.getElementById('micBtn').innerHTML = isMuted ? 
        '<i class="fas fa-microphone"></i>' : 
        '<i class="fas fa-microphone-slash"></i>';
    };

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      currentUser = user;
      initCall();
    });

    window.addEventListener('beforeunload', () => {
      const duration = callStartTime ? Math.floor((Date.now() - callStartTime) / 1000) : 0;
      logCall('answered', duration);
      cleanup();
    });
  </script>
</body>
</html>
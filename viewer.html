<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Viewer • Wonderland</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; font-family:'Segoe UI', sans-serif; }
    body { background:#fff; color:#111; display:flex; flex-direction:column; min-height:100vh; }
    header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,.08); position:sticky; top:0; z-index:10; }
    .title { font-weight:700; color:#e50914; font-size:18px; }
    #remote-player { flex:1; display:flex; align-items:center; justify-content:center; background:#000; color:#aaa; font-weight:600; border-radius:10px; margin:16px; overflow:hidden; }
    footer { text-align:center; padding:12px; font-size:14px; background:#f9f9f9; border-top:1px solid #eee; color:#555; }
    .live-dot { width:10px; height:10px; border-radius:50%; background:red; display:inline-block; margin-right:6px; animation:blink 1s infinite; }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0;} }
  </style>
</head>
<body>
  <header>
    <div class="title"><i class="fa-solid fa-video"></i> Live Viewer</div>
    <div id="status" style="color:#777;font-weight:600;">Checking live...</div>
  </header>

  <div id="remote-player">Waiting for host...</div>

  <footer>
    <span class="label-small">
      <span id="liveDot" class="live-dot" style="display:none"></span>
      Host: <span id="hostEmail">—</span> • <span id="viewCount">0</span> watching
    </span>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, updateDoc, onSnapshot, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBbR8R_3_Xf6QQPaZf9WDRLovSycAI1bKQ",
      authDomain: "emmy-programmers.firebaseapp.com",
      projectId: "emmy-programmers",
      storageBucket: "emmy-programmers.firebasestorage.app",
      messagingSenderId: "351752440867",
      appId: "1:351752440867:web:1f65d8c922d3d48e063596"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const AGORA_APP_ID = "fcfbeea054a84e529a1d984becbb4774";
    const CHANNEL_NAME = "live_room";

    const remotePlayer = document.getElementById('remote-player');
    const hostEmailEl = document.getElementById('hostEmail');
    const viewCountEl = document.getElementById('viewCount');
    const statusEl = document.getElementById('status');
    const liveDot = document.getElementById('liveDot');
    const sessionDocRef = doc(db, 'live_sessions', 'live_room');

    let currentUser = null;
    let client = null;

    // --- Load Agora SDK Dynamically ---
    const agoraScript = document.createElement('script');
    agoraScript.src = "https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js";
    agoraScript.onload = () => {
      console.log("Agora SDK loaded successfully");
      if (currentUser) initViewer();
    };
    document.head.appendChild(agoraScript);

    // --- Initialize viewer logic after SDK and user are ready ---
    function initViewer() {
      console.log("Viewer initialized");
      watchLiveSession();
    }

    // --- Join viewer to Agora live ---
    async function joinViewer() {
      if (typeof AgoraRTC === 'undefined') {
        return Swal.fire('Error', 'Agora SDK failed to load properly.');
      }

      if (client) return; // already joined

      client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
      await client.join(AGORA_APP_ID, CHANNEL_NAME, null, null);

      client.on("user-published", async (user, mediaType) => {
        await client.subscribe(user, mediaType);
        if (mediaType === "video") {
          remotePlayer.innerHTML = "";
          const playerDiv = document.createElement("div");
          playerDiv.style.width = "100%";
          playerDiv.style.height = "100%";
          remotePlayer.appendChild(playerDiv);
          user.videoTrack.play(playerDiv);
        }
        if (mediaType === "audio") {
          user.audioTrack.play();
        }
      });

      client.on("user-unpublished", user => {
        remotePlayer.innerHTML = "Host left the live.";
        leaveViewer();
      });

      await updateDoc(sessionDocRef, {
        viewers: arrayUnion(currentUser.email),
      });

      console.log("Viewer joined Agora & Firestore");
    }

    // --- Leave viewer when host ends live ---
    async function leaveViewer() {
      try {
        if (client) await client.leave();
        client = null;
        await updateDoc(sessionDocRef, {
          viewers: arrayRemove(currentUser.email),
        });
      } catch (e) {
        console.warn(e);
      }
    }

    // --- Listen for host live updates in Firestore ---
    function watchLiveSession() {
      onSnapshot(sessionDocRef, (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        hostEmailEl.textContent = data.hostEmail || '—';
        viewCountEl.textContent = data.viewerCount || 0;

        if (data.active) {
          liveDot.style.display = 'inline-block';
          statusEl.textContent = "Live now";
          joinViewer();
        } else {
          liveDot.style.display = 'none';
          statusEl.textContent = "Offline";
          remotePlayer.innerHTML = "Waiting for host...";
          leaveViewer();
        }
      });
    }

    // --- Firebase Auth check ---
    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "login.html";
      currentUser = user;
      console.log("Logged in as", user.email);

      // If Agora SDK is already loaded, start viewer
      if (typeof AgoraRTC !== "undefined") {
        initViewer();
      } else {
        console.log("Waiting for Agora SDK to load...");
      }
    });

    // --- Cleanup when closing the page ---
    window.addEventListener("beforeunload", () => {
      leaveViewer();
    });
  </script>
</body>
</html>